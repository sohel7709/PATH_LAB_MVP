<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=210mm, initial-scale=1.0">
    <title>Lab Report</title>
    <style>
        :root {
            --primary-color: {{styling.primaryColor}};
            --secondary-color: {{styling.secondaryColor}};
            --font-family: {{styling.fontFamily}};
            --font-size: {{styling.fontSize}}pt;
        }
        html, body {
            width: 210mm;
            /* Removed fixed height to allow content flow */
            margin: 0;
            padding: 0;
            background: #fff !important;
            color: #000 !important;
            font-family: var(--font-family, Arial, sans-serif);
            font-size: var(--font-size, 11pt); /* Default to 11pt */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        @page {
            size: A4;
            margin: 0; /* Control margins via padding/fixed elements */
        }
        .report-container {
            width: 210mm;
            min-height: 297mm; /* Use min-height for content */
            margin: 0 auto;
            padding-top: 35mm;  /* Space for fixed header */
            padding-bottom: 30mm; /* Space for fixed footer */
            padding-left: 10mm; /* Adjusted side padding */
            padding-right: 10mm;/* Adjusted side padding */
            box-sizing: border-box;
            position: relative; /* Needed for fixed header/footer */
        }
        /* Header */
        .report-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 35mm; /* Fixed header height */
            width: 100%;
            padding: 5mm; /* Padding within the header */
            box-sizing: border-box;
            background: #fff; /* Ensure background for overlap */
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #ccc; /* Optional separator */
        }
        .header-image {
            max-width: 100%; /* Allow image to scale down */
            max-height: 100%; /* Allow image to scale down */
            object-fit: contain;
            display: block;
        }
        .header-warning {
            font-size: 10pt;
            padding: 5mm;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            text-align: center;
        }
        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30mm; /* Fixed footer height */
            width: 100%;
            padding: 5mm; /* Padding within the footer */
            box-sizing: border-box;
            background: #fff; /* Ensure background for overlap */
            z-index: 10;
            border-top: 1pt solid #000; /* Separator line */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .footer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
        .footer-warning {
            font-size: 10pt;
            padding: 5mm;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #000;
            border-radius: 4px;
            text-align: center;
        }
        /* Patient Info */
        .patient-info {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Adjust for QR code */
            column-gap: 5mm; /* Reduced gap */
            padding: 5px 0;
            border-top: 2px solid #000; /* Moved top border here */
            border-bottom: 2px solid #000;
            font-size: 11pt;
            line-height: 1.3;
            margin-top: 5mm; /* Add margin to clear fixed header */
            margin-bottom: 5mm;
        }
        .patient-info-left, .patient-info-right {
            display: flex;
            flex-direction: column;
            gap: 2px; /* Reduced gap */
        }
         .patient-info-center { /* Style for QR code placeholder */
            width: 20mm;
            height: 20mm;
            border: 1px dashed #ccc;
            align-self: center; /* Center vertically */
        }
        .info-row {
            display: flex;
            justify-content: flex-start;
        }
        .info-label {
            font-weight: bold;
            min-width: 90px; /* Adjusted width */
            display: inline-block;
        }
        /* Test Group (Template Name + Table + Notes) */
        .test-group {
             page-break-inside: avoid; /* Try to keep group together */
             margin-bottom: 10mm;
        }
        .test-group-title { /* Renamed from test-title */
            text-align: center;
            font-size: 13pt; /* Slightly smaller */
            font-weight: bold;
            margin: 10px 0 8px 0; /* Adjusted margin */
            color: var(--primary-color, #000);
        }
        /* Test Results Table */
        .test-data {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            border: none; /* Remove outer table border */
            table-layout: fixed; /* Helps with column widths */
        }
        .test-data th, .test-data td {
            padding: 3px 8px; /* Reduced padding */
            border: none; /* Remove cell borders by default */
            font-size: 10pt; /* Smaller font for table content */
            vertical-align: top; /* Align top */
            line-height: 1.3;
        }
        .test-data thead tr {
             border-top: 1px solid black;
             border-bottom: 1px solid black;
        }
        .test-data th {
            font-weight: bold;
            color: var(--primary-color, #000);
            text-align: left;
            text-transform: uppercase;
        }
        /* Specific column alignments/widths */
        .test-data th:nth-child(1), .test-data td:nth-child(1) { width: 40%; text-align: left; }
        .test-data th:nth-child(2), .test-data td:nth-child(2) { width: 20%; text-align: right; padding-right: 15px; }
        .test-data th:nth-child(3), .test-data td:nth-child(3) { width: 10%; text-align: left; padding-left: 5px; }
        .test-data th:nth-child(4), .test-data td:nth-child(4) { width: 30%; text-align: left; }

        .abnormal {
            font-weight: bold !important;
            /* Removed background color and underline for cleaner look */
        }
        /* Style for header rows within the table body */
        .report-header-row td {
            font-weight: bold !important;
            font-size: 11pt !important;
            padding: 6px 8px !important;
            text-align: left !important;
            border-top: 1px solid #ccc !important;
            border-bottom: 1px solid #ccc !important;
            background-color: #f8f8f8 !important; /* Light grey background */
             -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
         /* Indentation for subparameters */
        .subparameter {
            padding-left: 20px !important;
        }
        /* Notes Sections */
        .template-notes, .test-notes {
            margin-top: 5px;
            font-size: 10pt;
            font-style: italic;
            white-space: pre-wrap; /* Respect line breaks */
            page-break-inside: avoid;
        }
        .test-notes { /* General notes might need more space */
             margin-top: 15px;
             padding-top: 10px;
             border-top: 1px solid #ccc;
        }
        /* Signature Section */
        .signature-section {
            display: flex;
            justify-content: flex-end; /* Align to the right */
            margin-top: 15mm; /* Adjusted margin */
            margin-bottom: 5mm; /* Adjusted margin */
            width: 100%;
             page-break-inside: avoid;
        }
        .signature-container {
            text-align: center;
            width: 180px; /* Slightly narrower */
        }
        .signature-image {
            height: 50px; /* Adjusted height */
            object-fit: contain;
            display: block;
            margin: 0 auto 5px auto; /* Add bottom margin */
        }
        .signature-name {
            font-weight: bold;
            margin-top: 5px;
            font-size: 11pt; /* Adjusted size */
        }
        .signature-designation {
            font-size: 10pt; /* Adjusted size */
            color: #333; /* Darker grey */
        }
        .signature-placeholder {
            height: 50px; /* Match image height */
            border-bottom: 1px solid #000;
            margin-bottom: 5px; /* Add bottom margin */
        }
        /* Hide UI elements */
        nav, header, button, .print-controls, .print-hidden {
            display: none !important;
        }
        .hidden-section {
            visibility: hidden; /* Use visibility to maintain layout space */
            height: 0;
            overflow: hidden;
            border: none; /* Hide borders too */
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="report-header{{#unless showHeader}} hidden-section{{/unless}}">
        {{#if headerImage}}
            <img src="{{headerImage}}" alt="Lab Header" class="header-image" />
        {{else}}
            <!-- Optional: Placeholder or message if no header image -->
             <div class="header-warning">Header Image Not Set</div>
        {{/if}}
    </div>

    <div class="report-container">
        <!-- Patient Info -->
        <div class="patient-info">
            <div class="patient-info-left">
                <div class="info-row"><span class="info-label">Patient Name:</span><span>{{patientName}}</span></div>
                <div class="info-row"><span class="info-label">Age/Gender:</span><span>{{patientAge}} / {{patientGender}}</span></div>
                <div class="info-row"><span class="info-label">Patient ID:</span><span>{{patientId}}</span></div>
            </div>
             <div class="patient-info-center"></div> <!-- QR Placeholder -->
            <div class="patient-info-right">
                <div class="info-row"><span class="info-label">Report Date:</span><span>{{reportDate}}</span></div>
                <div class="info-row"><span class="info-label">Referring Doctor:</span><span>{{referringDoctor}}</span></div>
                 <!-- Add Sample Collection Date/Time if available -->
                 {{#if sampleCollectionDate}}
                 <div class="info-row"><span class="info-label">Collected:</span><span>{{sampleCollectionDate}}</span></div>
                 {{/if}}
                 {{#if sampleType}}
                 <div class="info-row"><span class="info-label">Sample Type:</span><span>{{sampleType}}</span></div>
                 {{/if}}
            </div>
        </div>

        <!-- Test Results - Grouped by Template -->
        {{#each groupedResults}}
        <div class="test-group">
            <!-- Template Name Header -->
            <h3 class="test-group-title">{{this.templateName}}</h3>

            <!-- Parameters Table for this Template -->
            <table class="test-data">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Result</th>
                        <th>Unit</th>
                        <th>Reference Range</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each this.parameters}}
                    {{#if this.isHeader}}
                    <tr class="report-header-row">
                        <td colspan="4">{{this.name}}</td>
                    </tr>
                    {{else}}
                    <tr>
                        <td class="{{#if this.isSubparameter}}subparameter{{/if}}">{{this.name}}</td>
                        <td class="{{#if this.isAbnormal}}abnormal{{/if}}">{{this.result}}</td>
                        <td>{{this.unit}}</td>
                        <td>{{this.referenceRange}}</td>
                    </tr>
                    {{/if}}
                    {{/each}}
                </tbody>
            </table>
             <!-- Render Template Specific Notes -->
             <!-- DEBUG: Log the current group context -->
             <!-- {{debug this}} --> 
            {{#if this.templateSpecificNotes}}
            <div class="template-notes">
                <strong>Notes for {{this.templateName}}:</strong><br>
                {{{this.templateSpecificNotes}}} <!-- Use triple braces to prevent HTML escaping -->
            </div>
            {{/if}}
        </div>
        {{/each}}

        <!-- Overall Test Notes -->
        {{#if testNotes}}
        <div class="test-notes">
            <strong>Notes:</strong><br>
            {{testNotes}}
        </div>
        {{/if}}

        <!-- Signature Section -->
        <div class="signature-section">
            <div class="signature-container">
                {{#if signatureImage}}
                    <img src="{{signatureImage}}" alt="Signature" class="signature-image" />
                {{else}}
                    <div class="signature-placeholder"></div>
                {{/if}}
                <div class="signature-name">
                    {{#if verifiedBy}}{{verifiedBy}}{{else}}Lab Incharge{{/if}}
                </div>
                <div class="signature-designation">
                    {{#if designation}}{{designation}}{{else}}Pathologist{{/if}}
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <div class="footer{{#unless showFooter}} hidden-section{{/unless}}">
        {{#if footerImage}}
            <img src="{{footerImage}}" alt="Footer" />
        {{else}}
             <!-- Optional: Placeholder or message if no footer image -->
             <div class="footer-warning">Footer Image Not Set</div>
        {{/if}}
    </div>
</body>
</html>
